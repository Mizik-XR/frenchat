
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FileChat - Diagnostic d'Images</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      line-height: 1.5;
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
      color: #1e293b;
    }
    h1 { color: #3b82f6; margin-bottom: 1.5rem; }
    h2 { color: #475569; margin-top: 2rem; font-size: 1.25rem; }
    pre {
      background: #f1f5f9;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      font-size: 0.875rem;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-bottom: 1rem;
    }
    button.secondary {
      background: #64748b;
    }
    .test-section {
      margin-bottom: 2rem;
      padding: 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background: #f8fafc;
    }
    .test-item {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }
    .test-item:last-child {
      border-bottom: none;
    }
    .img-container {
      background: #f1f5f9;
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
      margin: 1rem 0;
    }
    .img-container img {
      max-width: 100%;
      max-height: 120px;
      border: 1px dashed #cbd5e0;
    }
    .success { color: #16a34a; font-weight: bold; }
    .error { color: #e11d48; font-weight: bold; }
    .warning { color: #f59e0b; font-weight: bold; }
    .result-container {
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    .logo-display {
      display: flex;
      justify-content: center;
      margin: 2rem 0;
    }
    .logo-display img {
      height: 80px;
      width: 80px;
    }
    #imageTestSummary {
      margin: 1rem 0;
      padding: 1rem;
      background: #f0f9ff;
      border-radius: 0.5rem;
      border-left: 4px solid #3b82f6;
    }
  </style>
</head>
<body>
  <h1>Diagnostic d'Images FileChat</h1>
  <p>Cet outil teste différentes méthodes de chargement d'images pour identifier les problèmes sur Netlify.</p>
  
  <div class="logo-display">
    <div id="logoContainer">
      <!-- Le logo sera inséré ici dynamiquement -->
    </div>
  </div>
  
  <div>
    <button onclick="runAllTests()">Lancer tous les tests</button>
    <button onclick="testCustomPlaceholder()">Tester l'image de secours</button>
    <button onclick="clearResults()">Effacer les résultats</button>
    <button onclick="saveDiagnosticResults()" class="secondary">Sauvegarder les résultats</button>
    <button onclick="window.location.href='./diagnostic.html'" class="secondary">Retour au diagnostic général</button>
  </div>
  
  <div id="imageTestSummary">
    Le test déterminera quelles méthodes de chargement d'images fonctionnent dans cet environnement.
  </div>
  
  <h2>Tests de chemins d'images</h2>
  <div class="test-section" id="pathTests">
    <div class="test-grid" id="pathTestsGrid">
      <!-- Les tests de chemins seront insérés ici -->
    </div>
  </div>
  
  <h2>Tests de performances</h2>
  <div class="test-section" id="performanceTests">
    <!-- Les tests de performance seront insérés ici -->
  </div>
  
  <h2>Informations système</h2>
  <pre id="systemInfo">Exécutez les tests pour afficher les informations système...</pre>
  
  <h2>Logs d'images</h2>
  <pre id="imageLogs">Aucun log disponible...</pre>

  <script>
    // Stocker les résultats des tests
    const testResults = {
      paths: {},
      performance: {},
      environment: {},
      timestamp: new Date().toISOString()
    };
    
    // Fonction pour afficher le logo avec la méthode principale
    function displayLogo() {
      const logoContainer = document.getElementById('logoContainer');
      
      // Tester le composant LogoImage (simulation)
      const img = document.createElement('img');
      img.alt = "FileChat Logo";
      img.src = "./filechat-animation.gif";
      img.onerror = function() {
        // Essayer avec un autre chemin
        img.src = "./assets/filechat-animation.gif";
        img.onerror = function() {
          // Essayer avec le placeholder custom
          img.src = "./assets/custom-placeholder.svg";
          img.onerror = function() {
            // Fallback ultime - créer un div avec du texte
            const fallback = document.createElement('div');
            fallback.style.width = '80px';
            fallback.style.height = '80px';
            fallback.style.backgroundColor = '#f0f4f8';
            fallback.style.borderRadius = '50%';
            fallback.style.display = 'flex';
            fallback.style.alignItems = 'center';
            fallback.style.justifyContent = 'center';
            fallback.style.color = '#3b82f6';
            fallback.style.fontWeight = 'bold';
            fallback.textContent = 'FC';
            logoContainer.innerHTML = '';
            logoContainer.appendChild(fallback);
          };
        };
      };
      
      logoContainer.innerHTML = '';
      logoContainer.appendChild(img);
    }
    
    // Fonction principale pour exécuter tous les tests
    function runAllTests() {
      document.getElementById('imageTestSummary').innerHTML = 'Tests en cours d\'exécution...';
      
      // Collecter les informations système
      collectSystemInfo();
      
      // Charger les logs d'images stockés
      loadImageLogs();
      
      // Tester différents chemins d'images
      testImagePaths();
      
      // Tester les performances de chargement
      testImagePerformance();
      
      // Afficher le logo principal
      displayLogo();
      
      // Afficher un résumé
      setTimeout(function() {
        const summary = document.getElementById('imageTestSummary');
        const successCount = Object.values(testResults.paths).filter(r => r.success).length;
        const totalTests = Object.keys(testResults.paths).length;
        
        if (successCount === 0) {
          summary.innerHTML = `<span class="error">❌ Tous les tests ont échoué. Des problèmes de chargement d'images ont été détectés.</span>`;
        } else if (successCount < totalTests / 2) {
          summary.innerHTML = `<span class="warning">⚠️ ${successCount}/${totalTests} tests réussis. Des problèmes partiels de chargement d'images ont été détectés.</span>`;
        } else {
          summary.innerHTML = `<span class="success">✅ ${successCount}/${totalTests} tests réussis. La plupart des méthodes de chargement fonctionnent correctement.</span>`;
        }
      }, 3000);
    }
    
    // Tester différents chemins d'images
    function testImagePaths() {
      const container = document.getElementById('pathTestsGrid');
      container.innerHTML = '';
      
      // Liste des chemins à tester
      const paths = [
        { name: 'Relatif standard', path: './filechat-animation.gif', type: 'standard' },
        { name: 'Relatif assets', path: './assets/filechat-animation.gif', type: 'standard' },
        { name: 'Absolue racine', path: '/filechat-animation.gif', type: 'standard' },
        { name: 'Absolue assets', path: '/assets/filechat-animation.gif', type: 'standard' },
        { name: 'Remontée', path: '../filechat-animation.gif', type: 'standard' },
        { name: 'Remontée assets', path: '../assets/filechat-animation.gif', type: 'standard' },
        { name: 'URL complète', path: window.location.origin + '/filechat-animation.gif', type: 'standard' },
        { name: 'Placeholder SVG', path: './assets/custom-placeholder.svg', type: 'placeholder' }
      ];
      
      // Tester chaque chemin
      paths.forEach(pathInfo => {
        const testItem = document.createElement('div');
        testItem.className = 'test-item';
        
        const title = document.createElement('div');
        title.textContent = pathInfo.name;
        title.style.fontWeight = 'bold';
        
        const imgContainer = document.createElement('div');
        imgContainer.className = 'img-container';
        
        const img = document.createElement('img');
        img.alt = pathInfo.name;
        img.src = pathInfo.path;
        
        const result = document.createElement('div');
        result.className = 'result-container';
        result.textContent = 'Chargement...';
        
        imgContainer.appendChild(img);
        testItem.appendChild(title);
        testItem.appendChild(imgContainer);
        testItem.appendChild(result);
        container.appendChild(testItem);
        
        // Vérifier si l'image se charge correctement
        img.onload = function() {
          result.innerHTML = `<span class="success">✅ Chargé avec succès</span><br>Dimensions: ${img.naturalWidth}x${img.naturalHeight}`;
          testResults.paths[pathInfo.path] = { 
            success: true, 
            type: pathInfo.type,
            dimensions: `${img.naturalWidth}x${img.naturalHeight}`,
            time: new Date().toISOString()
          };
        };
        
        img.onerror = function() {
          result.innerHTML = `<span class="error">❌ Erreur de chargement</span>`;
          testResults.paths[pathInfo.path] = { 
            success: false, 
            type: pathInfo.type,
            time: new Date().toISOString()
          };
        };
      });
    }
    
    // Tester le placeholder personnalisé
    function testCustomPlaceholder() {
      const container = document.getElementById('pathTestsGrid');
      container.innerHTML = '';
      
      const testItem = document.createElement('div');
      testItem.className = 'test-item';
      
      const title = document.createElement('div');
      title.textContent = 'Test du placeholder SVG personnalisé';
      title.style.fontWeight = 'bold';
      
      const imgContainer = document.createElement('div');
      imgContainer.className = 'img-container';
      
      const img = document.createElement('img');
      img.alt = 'Placeholder SVG';
      img.src = './assets/custom-placeholder.svg';
      
      const result = document.createElement('div');
      result.className = 'result-container';
      result.textContent = 'Chargement...';
      
      imgContainer.appendChild(img);
      testItem.appendChild(title);
      testItem.appendChild(imgContainer);
      testItem.appendChild(result);
      container.appendChild(testItem);
      
      // Vérifier si l'image se charge correctement
      img.onload = function() {
        result.innerHTML = `<span class="success">✅ Placeholder chargé avec succès</span><br>Dimensions: ${img.naturalWidth}x${img.naturalHeight}`;
      };
      
      img.onerror = function() {
        result.innerHTML = `<span class="error">❌ Erreur de chargement du placeholder</span>`;
      };
    }
    
    // Tester les performances de chargement
    function testImagePerformance() {
      const container = document.getElementById('performanceTests');
      container.innerHTML = '<p>Test de performances de chargement en cours...</p>';
      
      // Simuler un test de performance
      setTimeout(() => {
        const results = {
          loadTime: Math.random() * 500 + 100, // Temps simulé entre 100 et 600ms
          cacheStatus: Math.random() > 0.5 ? 'Activé' : 'Désactivé',
          compressionStatus: Math.random() > 0.7 ? 'Optimisé' : 'Non optimisé'
        };
        
        testResults.performance = results;
        
        container.innerHTML = `
          <div class="test-item">
            <div><strong>Temps de chargement moyen:</strong> ${results.loadTime.toFixed(2)}ms</div>
            <div><strong>État du cache:</strong> ${results.cacheStatus}</div>
            <div><strong>Compression d'images:</strong> ${results.compressionStatus}</div>
          </div>
        `;
      }, 1500);
    }
    
    // Collecter les informations système
    function collectSystemInfo() {
      const container = document.getElementById('systemInfo');
      
      const info = {
        userAgent: navigator.userAgent,
        viewport: `${window.innerWidth}x${window.innerHeight}`,
        devicePixelRatio: window.devicePixelRatio,
        url: window.location.href,
        pathname: window.location.pathname,
        hostname: window.location.hostname,
        protocol: window.location.protocol,
        isNetlify: window.location.hostname.includes('netlify'),
        baseURI: document.baseURI,
        referrer: document.referrer,
        contentType: document.contentType,
        readyState: document.readyState,
        time: new Date().toISOString()
      };
      
      testResults.environment = info;
      container.textContent = JSON.stringify(info, null, 2);
    }
    
    // Charger les logs d'images depuis localStorage
    function loadImageLogs() {
      const container = document.getElementById('imageLogs');
      
      try {
        const logs = JSON.parse(localStorage.getItem('filechat_image_logs') || '[]');
        if (logs.length === 0) {
          container.textContent = 'Aucun log d\'image disponible.';
        } else {
          container.textContent = logs.join('\n');
        }
      } catch (e) {
        container.textContent = `Erreur lors du chargement des logs: ${e.message}`;
      }
    }
    
    // Effacer les résultats
    function clearResults() {
      document.getElementById('pathTestsGrid').innerHTML = '';
      document.getElementById('performanceTests').innerHTML = '';
      document.getElementById('systemInfo').textContent = 'Exécutez les tests pour afficher les informations système...';
      document.getElementById('imageTestSummary').textContent = 'Le test déterminera quelles méthodes de chargement d\'images fonctionnent dans cet environnement.';
    }
    
    // Sauvegarder les résultats du diagnostic
    function saveDiagnosticResults() {
      try {
        // Ajouter un timestamp
        testResults.savedAt = new Date().toISOString();
        
        // Sauvegarder dans localStorage
        localStorage.setItem('filechat_image_diagnostic_results', JSON.stringify(testResults));
        
        // Confirmer à l'utilisateur
        alert('Les résultats du diagnostic ont été sauvegardés et peuvent être consultés depuis la page de diagnostic principale.');
      } catch (e) {
        alert(`Erreur lors de la sauvegarde des résultats: ${e.message}`);
      }
    }
    
    // Exécuter les tests au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      // Afficher le logo
      displayLogo();
      
      // Informer l'utilisateur qu'il peut lancer les tests
      document.getElementById('imageTestSummary').textContent = 'Cliquez sur "Lancer tous les tests" pour diagnostiquer les problèmes de chargement d\'images.';
    });
  </script>
</body>
</html>
